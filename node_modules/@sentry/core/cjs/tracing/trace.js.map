{"version":3,"file":"trace.js","sources":["../../../src/tracing/trace.ts"],"sourcesContent":["import type { TransactionContext } from '@sentry/types';\nimport { dropUndefinedKeys, isThenable, logger, tracingContextFromHeaders } from '@sentry/utils';\n\nimport { DEBUG_BUILD } from '../debug-build';\nimport { getCurrentScope, withScope } from '../exports';\nimport type { Hub } from '../hub';\nimport { getCurrentHub } from '../hub';\nimport { hasTracingEnabled } from '../utils/hasTracingEnabled';\nimport type { Span } from './span';\n\n/**\n * Wraps a function with a transaction/span and finishes the span after the function is done.\n *\n * Note that if you have not enabled tracing extensions via `addTracingExtensions`\n * or you didn't set `tracesSampleRate`, this function will not generate spans\n * and the `span` returned from the callback will be undefined.\n *\n * This function is meant to be used internally and may break at any time. Use at your own risk.\n *\n * @internal\n * @private\n */\nexport function trace<T>(\n  context: TransactionContext,\n  callback: (span?: Span) => T,\n  // eslint-disable-next-line @typescript-eslint/no-empty-function\n  onError: (error: unknown, span?: Span) => void = () => {},\n  // eslint-disable-next-line @typescript-eslint/no-empty-function\n  afterFinish: () => void = () => {},\n): T {\n  const ctx = normalizeContext(context);\n\n  const hub = getCurrentHub();\n  const scope = getCurrentScope();\n  const parentSpan = scope.getSpan();\n\n  const activeSpan = createChildSpanOrTransaction(hub, parentSpan, ctx);\n\n  scope.setSpan(activeSpan);\n\n  function finishAndSetSpan(): void {\n    activeSpan && activeSpan.end();\n    scope.setSpan(parentSpan);\n  }\n\n  let maybePromiseResult: T;\n  try {\n    maybePromiseResult = callback(activeSpan);\n  } catch (e) {\n    activeSpan && activeSpan.setStatus('internal_error');\n    onError(e, activeSpan);\n    finishAndSetSpan();\n    afterFinish();\n    throw e;\n  }\n\n  if (isThenable(maybePromiseResult)) {\n    // @ts-expect-error - the isThenable check returns the \"wrong\" type here\n    return maybePromiseResult.then(\n      res => {\n        finishAndSetSpan();\n        afterFinish();\n        return res;\n      },\n      e => {\n        activeSpan && activeSpan.setStatus('internal_error');\n        onError(e, activeSpan);\n        finishAndSetSpan();\n        afterFinish();\n        throw e;\n      },\n    );\n  }\n\n  finishAndSetSpan();\n  afterFinish();\n  return maybePromiseResult;\n}\n\n/**\n * Wraps a function with a transaction/span and finishes the span after the function is done.\n * The created span is the active span and will be used as parent by other spans created inside the function\n * and can be accessed via `Sentry.getSpan()`, as long as the function is executed while the scope is active.\n *\n * If you want to create a span that is not set as active, use {@link startInactiveSpan}.\n *\n * Note that if you have not enabled tracing extensions via `addTracingExtensions`\n * or you didn't set `tracesSampleRate`, this function will not generate spans\n * and the `span` returned from the callback will be undefined.\n */\nexport function startSpan<T>(context: TransactionContext, callback: (span: Span | undefined) => T): T {\n  const ctx = normalizeContext(context);\n\n  // @ts-expect-error - isThenable returns the wrong type\n  return withScope(scope => {\n    const hub = getCurrentHub();\n    const parentSpan = scope.getSpan();\n\n    const activeSpan = createChildSpanOrTransaction(hub, parentSpan, ctx);\n    scope.setSpan(activeSpan);\n\n    function finishAndSetSpan(): void {\n      activeSpan && activeSpan.end();\n    }\n\n    let maybePromiseResult: T;\n    try {\n      maybePromiseResult = callback(activeSpan);\n    } catch (e) {\n      activeSpan && activeSpan.setStatus('internal_error');\n      finishAndSetSpan();\n      throw e;\n    }\n\n    if (isThenable(maybePromiseResult)) {\n      return maybePromiseResult.then(\n        res => {\n          finishAndSetSpan();\n          return res;\n        },\n        e => {\n          activeSpan && activeSpan.setStatus('internal_error');\n          finishAndSetSpan();\n          throw e;\n        },\n      );\n    }\n\n    finishAndSetSpan();\n    return maybePromiseResult;\n  });\n}\n\n/**\n * @deprecated Use {@link startSpan} instead.\n */\nexport const startActiveSpan = startSpan;\n\n/**\n * Similar to `Sentry.startSpan`. Wraps a function with a transaction/span, but does not finish the span\n * after the function is done automatically.\n *\n * The created span is the active span and will be used as parent by other spans created inside the function\n * and can be accessed via `Sentry.getActiveSpan()`, as long as the function is executed while the scope is active.\n *\n * Note that if you have not enabled tracing extensions via `addTracingExtensions`\n * or you didn't set `tracesSampleRate`, this function will not generate spans\n * and the `span` returned from the callback will be undefined.\n */\nexport function startSpanManual<T>(\n  context: TransactionContext,\n  callback: (span: Span | undefined, finish: () => void) => T,\n): T {\n  const ctx = normalizeContext(context);\n\n  // @ts-expect-error - isThenable returns the wrong type\n  return withScope(scope => {\n    const hub = getCurrentHub();\n    const parentSpan = scope.getSpan();\n\n    const activeSpan = createChildSpanOrTransaction(hub, parentSpan, ctx);\n    scope.setSpan(activeSpan);\n\n    function finishAndSetSpan(): void {\n      activeSpan && activeSpan.end();\n    }\n\n    let maybePromiseResult: T;\n    try {\n      maybePromiseResult = callback(activeSpan, finishAndSetSpan);\n    } catch (e) {\n      activeSpan && activeSpan.setStatus('internal_error');\n      throw e;\n    }\n\n    if (isThenable(maybePromiseResult)) {\n      return maybePromiseResult.then(\n        res => res,\n        e => {\n          activeSpan && activeSpan.setStatus('internal_error');\n          throw e;\n        },\n      );\n    }\n\n    return maybePromiseResult;\n  });\n}\n\n/**\n * Creates a span. This span is not set as active, so will not get automatic instrumentation spans\n * as children or be able to be accessed via `Sentry.getSpan()`.\n *\n * If you want to create a span that is set as active, use {@link startSpan}.\n *\n * Note that if you have not enabled tracing extensions via `addTracingExtensions`\n * or you didn't set `tracesSampleRate` or `tracesSampler`, this function will not generate spans\n * and the `span` returned from the callback will be undefined.\n */\nexport function startInactiveSpan(context: TransactionContext): Span | undefined {\n  if (!hasTracingEnabled()) {\n    return undefined;\n  }\n\n  const ctx = { ...context };\n  // If a name is set and a description is not, set the description to the name.\n  if (ctx.name !== undefined && ctx.description === undefined) {\n    ctx.description = ctx.name;\n  }\n\n  const hub = getCurrentHub();\n  const parentSpan = getActiveSpan();\n  return parentSpan ? parentSpan.startChild(ctx) : hub.startTransaction(ctx);\n}\n\n/**\n * Returns the currently active span.\n */\nexport function getActiveSpan(): Span | undefined {\n  return getCurrentScope().getSpan();\n}\n\nexport function continueTrace({\n  sentryTrace,\n  baggage,\n}: {\n  sentryTrace: Parameters<typeof tracingContextFromHeaders>[0];\n  baggage: Parameters<typeof tracingContextFromHeaders>[1];\n}): Partial<TransactionContext>;\nexport function continueTrace<V>(\n  {\n    sentryTrace,\n    baggage,\n  }: {\n    sentryTrace: Parameters<typeof tracingContextFromHeaders>[0];\n    baggage: Parameters<typeof tracingContextFromHeaders>[1];\n  },\n  callback: (transactionContext: Partial<TransactionContext>) => V,\n): V;\n/**\n * Continue a trace from `sentry-trace` and `baggage` values.\n * These values can be obtained from incoming request headers,\n * or in the browser from `<meta name=\"sentry-trace\">` and `<meta name=\"baggage\">` HTML tags.\n *\n * The callback receives a transactionContext that may be used for `startTransaction` or `startSpan`.\n */\nexport function continueTrace<V>(\n  {\n    sentryTrace,\n    baggage,\n  }: {\n    sentryTrace: Parameters<typeof tracingContextFromHeaders>[0];\n    baggage: Parameters<typeof tracingContextFromHeaders>[1];\n  },\n  callback?: (transactionContext: Partial<TransactionContext>) => V,\n): V | Partial<TransactionContext> {\n  const currentScope = getCurrentScope();\n\n  const { traceparentData, dynamicSamplingContext, propagationContext } = tracingContextFromHeaders(\n    sentryTrace,\n    baggage,\n  );\n\n  currentScope.setPropagationContext(propagationContext);\n\n  if (DEBUG_BUILD && traceparentData) {\n    logger.log(`[Tracing] Continuing trace ${traceparentData.traceId}.`);\n  }\n\n  const transactionContext: Partial<TransactionContext> = {\n    ...traceparentData,\n    metadata: dropUndefinedKeys({\n      dynamicSamplingContext: traceparentData && !dynamicSamplingContext ? {} : dynamicSamplingContext,\n    }),\n  };\n\n  if (!callback) {\n    return transactionContext;\n  }\n\n  return callback(transactionContext);\n}\n\nfunction createChildSpanOrTransaction(\n  hub: Hub,\n  parentSpan: Span | undefined,\n  ctx: TransactionContext,\n): Span | undefined {\n  if (!hasTracingEnabled()) {\n    return undefined;\n  }\n  return parentSpan ? parentSpan.startChild(ctx) : hub.startTransaction(ctx);\n}\n\nfunction normalizeContext(context: TransactionContext): TransactionContext {\n  const ctx = { ...context };\n  // If a name is set and a description is not, set the description to the name.\n  if (ctx.name !== undefined && ctx.description === undefined) {\n    ctx.description = ctx.name;\n  }\n\n  return ctx;\n}\n"],"names":["hub","getCurrentHub","getCurrentScope","isThenable","withScope","hasTracingEnabled","tracingContextFromHeaders","DEBUG_BUILD","logger","dropUndefinedKeys"],"mappings":"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"}